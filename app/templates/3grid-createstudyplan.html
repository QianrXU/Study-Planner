{% extends "base.html" %}
{% block content %}

<div class="container" style="margin-top: 40px; margin-bottom: 40px;">
  <div class="gridsystem row">
    
    <div class="units col-12 col-md-auto" id="units">
      <div class="progress" id="units-progress"><div class="progress-bar" role="progressbar" style="width: 100%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div></div>
        <div id="units-content">

          <h2 id="select-units-title">Select units</h2>
            <div id="unitsSelection">
              <!-- If there exists conversion units for this course, they will appear here otherwise this will be hidden. This is associated with the JS UnitLists object (see below) -->
              <p class="unit-heading" id="type1" draggable="false" style="display: none;">Type1</p>
              <div class="unit-draggables" id="type1units" style="display: none;">
                <ul id="type1unitsUL" style="display: none;"></ul>
              </div>
            </div>

        </div>
        <div id="units-bottom">
          <div id="keys">
            <h4 style="font-size: 1rem;">Availability keys</h4>
            <p style="margin-bottom: 5px;">ðŸŸ¡ Only run in Semester 1</p>
            <p style="margin-bottom: 5px;">ðŸŸ¢ Only run in Semester 2</p>
            <p style="margin-bottom: 5px;">ðŸŸ  Runs in Semester 1 and 2</p>
            <p style="margin-bottom: 5px;">ðŸ”µ Not available</p>
            <p style="margin-bottom: 5px;">â­• Non-standard</p>
            <p style="margin-bottom: 5px;">âš« No information</p>
          </div>
          <!-- the info icon that show the general-info modal below -Valerie -->
          <div id="info-icon"> 
            <!-- the icon listens to a click function to show the modal -->
            <i class="fa-solid fa-circle-info" onclick="openModal()" id="myModal"></i>
          </div>
          <!-- General info modal that can triggered by clicking the large info icon at the bottom of availability key lists -Valerie -->
          <div id="modal-container">
            <div class="modal" id="my-modal">
              <div class="modal-content">
                <div class="modal-header">
                  <!-- the icon listens to a click action to close the modal-->
                  <i class="fa-solid fa-rectangle-xmark" id="close-info" onclick="closeModal()"></i>
                </div>
                <div class="modal-body">
                  <h3>GENERAL INFORMATION</h3>
                  <br>
                  <H5>Core Units</H5>
                  <p>Core units are the compulsory units in your chosen course. In the Study Planner tool, you must allocate these units before allocating optional units.</p>
                  <hr style="border-top: 3px solid #505050; margin: 20px 0px; width: 60%;">
                  <h3>BACHELOR'S DEGREE</h3>
                  <p>UWA's three-year undergraduate courses each comprise 24 units. The units you study must include:
                    <ul class="general">
                      <li>a degree-specific major; and</li>
                      <li>at least four units which satisfy the broadening requirements of your course.</li>
                    </ul>
                  </p>
                  <p>There are some limits you need to be aware of:
                    <ul class="general">
                      <li>you cannot include more than 12 units at Level 1; and</li>
                      <li>you must pass at least 3 units at Level 3.</li>
                    </ul>
                  </p>
                  <H5>Broadening Units</H5>
                  <p>All students towards a Bachelor's Degree at UWA are required to broaden their studies by completing a minimum of four units (24 points) of study outside their degree specific major.</p>
                  <H5>Bridging Units</H5>
                  <p>Bridging units are designed for students who have not met the relevant ATAR level (or equivalent qualification) required as prerequisites for their major. Bridging units must be successfully completed within the first 48 points of study.</p>
                  <hr style="border-top: 3px solid #505050; margin: 20px 0px; width: 60%;">
                  <h3>MASTER'S DEGREE</h3>
                  <h5>Conversion Units</h5>
                  <p>For some courses, there may be special conditions on admission. Students who have completed degree studies in a non-cognate area or equivalenet (as recognised by the University), must complete relevant conversion units. This is determined upon offer of admission and by the scope of a students's prior study.</p>
                </div>
              </div>
            </div>
          </div>
        </div>
    </div>

    <div class="col-12 col-md" id="grid">
      <div class="progress" id="units-progress-grid"><div class="progress-bar" role="progressbar" style="width: 100%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div></div>
        <div id="grid-content">
          <div id="course-information">
            <!-- Pulled from prior selection pages -->
            <p id="course-title">{{ selectedCourse }}</p> 
            <p id="course-major">Major: {{ selectedMajor }}</p>
            <p id="administration">Administered by: {{ faculty }}</p>
            <p id="course-code">Course code: {{ coursecode }}</p> 
          </div>

          <hr style="border-top: 1px solid #505050;">

          <!--  Grid system. --> 
          <div class="container" id="gridcontainer">

            <!-- <div id="trash" ondrop="removeUnit(event)"><i class="fa fa-trash" aria-hidden="true" style="font-size: 2em; float: right;"></i></div> -->

            <!--  Start semester/year determined by what user selects in dropdown in previous window -->
            <p class="semester-paragraph" id="year1semester1">Semester 1, 2023</p>
            <div class="semester-row" id="row1"> <!--  Add/delete row button to add/delete. -->
              <div class="target" id="year1sem1_1" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
              <div class="target" id="year1sem1_2" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
              <div class="target" id="year1sem1_3" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
              <div class="target" id="year1sem1_4" ondrop="drop(event)" ondragover="allowDrop(event)"></div> 
              <!--https://github.com/QianrXU/Study-Planner/issues/82-->
              <div class="target" id="year1sem1_5" ondrop="drop(event)" ondragover="allowDrop(event)" style="display: none;"></div>  <!-- if overloading, unhide -->
              <!--Font awesome icon that will able to add new unit in the selector- Ancy-->
              <button onclick="addSem11OverLoad(this);" class="btn-ol" id="show_hide_bt1" >
                  <i class="fa fa-plus-circle"></i> Add
              </button>
            </div>

            <p class="semester-paragraph" id="year1semester2">Semester 2, 2023</p>
            <div class="semester-row" id="row2">
              <div class="target" id="year1sem2_1" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
              <div class="target" id="year1sem2_2" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
              <div class="target" id="year1sem2_3" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
              <div class="target" id="year1sem2_4" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
              <div class="target" id="year1sem2_5" ondrop="drop(event)" ondragover="allowDrop(event)" style="display: none;"></div>  <!-- if overloading, unhide -->
               <!--Font awesome icon that will able to add new unit in the selector- Ancy-->
               <!--Clicking '+' calls the function to add or remove a grid-->
               <button onclick="addSem12OverLoad(this);" class="btn-ol" id="show_hide_bt2" >
                 <i class="fa fa-plus-circle"></i> Add
               </button>            
          </div>

            <p class="semester-paragraph" id="year2semester1">Semester 1, 2024</p>
            <div class="semester-row" id="row3">
              <div class="target" id="year2sem1_1" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
              <div class="target" id="year2sem1_2" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
              <div class="target" id="year2sem1_3" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
              <div class="target" id="year2sem1_4" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
              <div class="target" id="year2sem1_5" ondrop="drop(event)" ondragover="allowDrop(event)" style="display: none;" ></div>  <!-- if overloading, unhide -->
               <!--Font awesome icon that will able to add new unit in the selector- Ancy-->
               <button onclick="addSem21OverLoad(this);" class="btn-ol" id="show_hide_bt3" >
                 <i class="fa fa-plus-circle"></i> Add
               </button>
            </div>

            <p class="semester-paragraph" id="year2semester2">Semester 2, 2024</p>
            <div class="semester-row" id="row4">
              <div class="target" id="year2sem2_1" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
              <div class="target" id="year2sem2_2" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
              <div class="target" id="year2sem2_3" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
              <div class="target" id="year2sem2_4" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
              <div class="target" id="year2sem2_5" ondrop="drop(event)" ondragover="allowDrop(event)" style="display: none;" ></div>  <!-- if overloading, unhide -->
               <!--Font awesome icon that will able to add new unit in the selector- Ancy-->
               <button onclick="addSem22OverLoad(this);" class="btn-ol" id="show_hide_bt4" >
           <i class="fa fa-plus-circle"></i> Add
       </button>
            </div>

          </div>
      </div>
      
      <a onClick="CreatePDFfromHTML()" class ="button_general" id="selectmajorbutton">Download<span class="arrow"><i class="fa-sharp fa-solid fa-angles-down" id="buttonarrow"></i></span></a>
    
    </div>

  </div>
</div>


    


<!-- Units variable from back end -->
<div id="unitList" style="display: none;">{{ units }}</div>
<div id="unitCodeList" style="display: none;">{{ availability }}</div>

<!--Script to support PDF conversion-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.5.3/jspdf.min.js"></script> 
<script src="https://html2canvas.hertzen.com/dist/html2canvas.js"></script>

<script>
// Remove major information from frontend if doesn't contain anything valuable
if (document.getElementById("course-major").innerHTML == "Major: No major or specialisation available"){
  document.getElementById("course-major").style.display = "none";
}

// Process units variable from backend in JS
var units = document.getElementById("unitList").innerHTML;
var units = units.slice(1, -23); // slice off back of string and do some further processing below
var units = units.replace(/'/g, '');
var units = units.replace(/"/g, '');
var unitsArray = units.split(", NEXT_UNIT_ROLE, ") // Split into array when this test occurs

// Process unitInformation variable to retrieve availability
var unitInformation = document.getElementById("unitCodeList").innerHTML;
var unitInformation = unitInformation.slice(1, -2); // slice off back of string and do some further processing below
var unitInformation = unitInformation.replace(/'/g, '');
var unitInformation = unitInformation.replace(/"/g, '');
unitInformation = unitInformation.split('***')
unitInformation = unitInformation.map(elem => elem.replace(", ", "")); 
unitInformation = unitInformation.map(elem => elem.replace(": ", "")); 

window.addEventListener('DOMContentLoaded', (event) => {
  unitsArray.forEach(element => {
    unitRole = element.split(", ***, "); // This split stirng is decided in routes.py
    unitRole = unitRole.map(elem => elem.replace(", ***", "")); // if there would be any erronous split symbols (&amp;*:,) that have come across despite the split, clean those up

    unitlists = {} // Dictionary for unit roles and units

    var unitRoleUnits = unitRole[2] // take index 2 are the units that belong to the unit role.
    if (unitRole[2] == null) { // test if the units belonging to this unit role is empty, in which case, don't display the role, replace with text below
    unitRoleUnits = "No information to be displayed. Check with faculty.";
    }
    unitlists[unitRole[0]] = unitRoleUnits; // place in unitlists dictionary: key is index 0 (unit code) and value is index 2 (units belonging to this unit role) from unitRole list

    // Extract information about unit roles
    var unitInfo = unitRole[1] 
    
    // Process key-value pairs in unitlists dictionary
    for (const [key, value] of Object.entries(unitlists)) {
      const unitRoleHeader = document.createElement("p"); // create unit headers for each unit role
      const keyNode = document.createTextNode(key + " ");
      unitRoleHeader.appendChild(keyNode);
      unitRoleHeader.setAttribute("class", "unit-heading");
      const heading = document.getElementById("unitsSelection");
      heading.appendChild(unitRoleHeader);
      const unitRoleUl = document.createElement("ul"); // create and append unit-draggables div to each unit role
      heading.appendChild(unitRoleUl);
      unitRoleUl.setAttribute("class", "unit-ul");
      
      // appends tooltip icon to header
      const infoDiv = document.createElement("div");
      unitRoleHeader.appendChild(infoDiv);
      infoDiv.setAttribute('class', 'tooltipinfo');
      infoDiv.insertAdjacentHTML("afterbegin", '<i class="fa-solid fa-circle-info"></i>');

      // appends unit info to tooltip icon
      const infotext = document.createElement("span");
      infotext.setAttribute('class', 'tooltiptextinfo');
      infoDiv.appendChild(infotext);
      infotext.insertAdjacentHTML("afterbegin", unitInfo);

      // The below splits each unit role list and dynamically creates li's under the correct heading (key)
      var unitArr = (`${value}`).split('***, '); // split conversion units into list (split by comma)
      unitArr = unitArr.map(elem => elem.replace("***", "")); 

      var unitArrLength = unitArr.length // grab length of each unit role list
      for (i = 0; i < unitArrLength; i++) {
        var lielement = document.createElement("li"); // create list item
        lielement.appendChild(document.createTextNode(unitArr[i].trim())); // create and append content of list item (i.e., unit)
        lielement.setAttribute("id", unitArr[i].trim()); // set ID of new list item to 'Unit Code Unit Name'
        if (unitArr[i].trim() == "No information to be displayed. Check with faculty.") {
          unitRoleUl.appendChild(lielement);
          lielement.setAttribute("class", "no_marker");
        }
        else {
          lielement.setAttribute("draggable", "true"); // set draggable of new list item to 'true'
          lielement.setAttribute("ondragstart", "drag(event)");// set ondragstart event of new list item to 'drag(event)'

          // Find availability of units and attach the class (sem1, sem2 or sem1and2, to each li element)
          var availabilityinfo = unitInformation.indexOf(unitArr[i].trim())
          if (availabilityinfo != -1) { // if unit was found in unitInformation array, i.e., does not return -1
            availability = unitInformation[availabilityinfo+1]
            if (availability.includes("Semester 1")) {
              lielement.setAttribute("class", "sem1");
            }
            if (availability.includes("Semester 2")) {
                lielement.setAttribute("class", "sem2");
            }
            if (availability.includes("Semester 1") && availability.includes("Semester 2")) {
                lielement.setAttribute("class", "sem1and2");
            }
            if (availability.includes("Not available")) {
                lielement.setAttribute("class", "not_available");
            }
            if (availability.includes("Non-standard")) {
                lielement.setAttribute("class", "non_standard");
            }
          }
          else {lielement.setAttribute("class", "element")}
          
          unitRoleUl.appendChild(lielement); // append li element/unit
        }
      }
    }
  });

});


// Click event - Add modal on click?
document.addEventListener('click',function(e){
    if(e.target && e.target.classList == 'element'){
      id = event.target.id;
      alert("You've clicked on " + id); 
     }
 });

// Functions to show and close the general-info modal - Done by Valerie
//Modal - open general-info modal
function openModal(){
  const modal = document.getElementById('my-modal'); // get the modal that needs to be showed
  modal.style.display = 'block'; //show the modal after click action
}
// Modal - close general-info modal
function closeModal(){
  const modal = document.getElementById('my-modal'); // get the modal that needs to be closed
  modal.style.display = 'none'; //hide the modal after clicking the close button
}


// /* Event listener - listens for changes to units content div */
// detect_units_changing = document.getElementById("conversionUL");
// observer = new MutationObserver(function(mutationsList, observer) {detectedChange();});
// observer.observe(detect_units_changing, {characterData: false, childList: true, attributes: false});

// /* Function when course is changed */
// function detectedChange(){
//   // posts new course selection to console log
//   detected_course = document.getElementById("course-title").innerHTML;
//   console.log(detected_course);
// }

// Dragstart - save initial position somehow?
document.addEventListener('dragstart',function(e){
    if(e.target && e.target.classList == 'element'){
      console.log("dragging")
      id = event.target.id;
     }
     
 });

// Grid system

let offset = [0, 0]

function allowDrop(ev) {
  var t = ev.target;
  while (t !== null && !t.classList.contains("target")) {
    t = t.parentNode;
  }
  if (t && t.childNodes.length > 0) { // Return false if user tries to place more than 1 unit per unit div
    return false;
  }
  ev.preventDefault()
}

function drag(ev) {
  ev.dataTransfer.setData('dragID', ev.target.id)
  offset = [
    ev.target.offsetLeft - ev.clientX,
    ev.target.offsetTop - ev.clientY
  ]
}

function drop(ev) {
  ev.preventDefault();
  const data = ev.dataTransfer.getData('dragID');
  ev.target.appendChild(document.getElementById(data));
}

// Removing units from grid

// Click event - removes unit upon click. Have to change this to something else
// e.g., at drop on bin icon, element is removed
// alternative 1. if event id is removed, append clone to initial list?
// document.addEventListener('click',function(e){
//   if(e.target && e.target.classList == 'element'){
//     event.target.parentNode.removeChild(event.target);
//    }
//  });

// Resets all dragover activities - needed for trash to work, however, disables the constraint on only one unit per div. Find other way of dealing with trash? /C
// document.addEventListener("dragover", function(event) {
//   event.preventDefault();
// });

removedUnits = []
function removeUnit(ev){
  const data = ev.dataTransfer.getData('dragID');
  removedUnits.push(document.getElementById(data)); // Removed unit data saved to removedUnits
  document.getElementById(data).style.display = "none"; // Change style of element to none upon removal
  console.log(removedUnits)
}


// function for downloading a pdf (whole page)
// code based on the second answer from this page: https://stackoverflow.com/questions/17293135/download-a-div-in-a-html-page-as-pdf-using-javascript

function CreatePDFfromHTML() {
    var div_Width = $("#grid-content").width();
    var div_Height = $("#grid-content").height();
    var top_left_margin = 15;
    var PDF_Width = div_Width + (top_left_margin * 2);
    var PDF_Height = (PDF_Width * 1.5) + (top_left_margin * 2);
    var canvas_image_width = div_Width;
    var canvas_image_height = div_Height;

    var totalPDFPages = Math.ceil(div_Height / PDF_Height) - 1;

    html2canvas($("#grid-content")[0]).then(function (canvas) {
        var imgData = canvas.toDataURL("image/jpeg", 1.0);
        var pdf = new jsPDF('p', 'pt', [PDF_Width, PDF_Height]);
        pdf.addImage(imgData, 'JPG', top_left_margin, top_left_margin, canvas_image_width, canvas_image_height);
        for (var i = 1; i <= totalPDFPages; i++) { 
            pdf.addPage(PDF_Width, PDF_Height);
            pdf.addImage(imgData, 'JPG', top_left_margin, -(PDF_Height*i)+(top_left_margin*4),canvas_image_width,canvas_image_height);
        }
        pdf.save("study-plan.pdf");
    });
}

//Function for overloading - Ancy
// This add one more grid to each semester if the user wants to do 5 units in a semester

//Function that will display the fifth unit if user click '+' button and remove that grid when click '-' icon
// https://github.com/QianrXU/Study-Planner/issues/85
// https://github.com/QianrXU/Study-Planner/issues/79
function addSem11OverLoad(button) {
  var year1sem1_5 = document.getElementById("year1sem1_5");
   $(button).find('i').remove();
   if ($(button).text().trim() == 'Add') {
     $(button).html($('<i/>',{class:'fa fa-minus-circle'})).append('Remove');
     year1sem1_5.style.display = "block";
    }
    else {
      $(button).html($('<i/>',{class:'fa fa-plus-circle'})).append('Add');
      year1sem1_5.style.display = "none"
    }
  
}
//Function that will display the fifth unit if user click '+' button and remove that grid when click '-' icon
function addSem12OverLoad(button) {
  var x = document.getElementById("year1sem2_5");
   $(button).find('i').remove();
   if ($(button).text().trim() == 'Add') {
     $(button).html($('<i/>',{class:'fa fa-minus-circle'})).append('Remove');
     x.style.display = "block";
    }
    else {
      $(button).html($('<i/>',{class:'fa fa-plus-circle'})).append('Add');
      x.style.display = "none"
    }
  
}
//Function that will display the fifth unit if user click '+' button and remove that grid when click '-' icon
function addSem21OverLoad(button) {
  var x = document.getElementById("year2sem1_5");
   $(button).find('i').remove();
   if ($(button).text().trim() == 'Add') {
     $(button).html($('<i/>',{class:'fa fa-minus-circle'})).append('Remove');
     x.style.display = "block";}
    else {
      $(button).html($('<i/>',{class:'fa fa-plus-circle'})).append('Add');
      x.style.display = "none"
    }
  
}
//Function that will display the fifth unit if user click '+' button and remove that grid when click '-' icon
function addSem22OverLoad(button) {
   var x = document.getElementById("year2sem2_5");
   $(button).find('i').remove();
   if ($(button).text().trim() == 'Add') {
     $(button).html($('<i/>',{class:'fa fa-minus-circle'})).append('Remove');
     x.style.display = "block";
    }
    else {
      $(button).html($('<i/>',{class:'fa fa-plus-circle'})).append('Add');
      x.style.display = "none"
    }
}

</script>


{% endblock %}